---
const { target, label = 'Starts in' } = Astro.props as { target?: string; label?: string };
const uid = `countdown-${Math.random().toString(36).slice(2,9)}`;

function pad(n:number){ return String(n).padStart(2, '0'); }

let initial = { days: '--', hours: '--', minutes: '--', seconds: '--' };
let liveText = target ? 'Countdown time remaining' : 'Countdown not set';

if(target){
  const t = new Date(target);
  if(!isNaN(t.getTime())){
    const diff = Math.max(0, t.getTime() - Date.now());
    const sec = Math.floor(diff / 1000);
    const days = Math.floor(sec / 86400);
    const hours = Math.floor((sec % 86400) / 3600);
    const minutes = Math.floor((sec % 3600) / 60);
    const seconds = sec % 60;

    initial = { days: String(days), hours: pad(hours), minutes: pad(minutes), seconds: pad(seconds) };
    liveText = `${days} days ${pad(hours)}:${pad(minutes)}:${pad(seconds)} remaining`;
  } else {
    liveText = 'Date not set';
  }
}
---

<div id={uid} class="rounded-lg border border-graphite-700/30 p-4" data-target={target ?? undefined}>
  <div class="text-sm text-graphite-200">{label}</div>

  <div class="mt-3 grid grid-cols-4 gap-2 text-center" data-countdown>
    <div>
      <div class="text-2xl font-semibold" data-unit="days">{initial.days}</div>
      <div class="text-xs small-muted">Days</div>
    </div>
    <div>
      <div class="text-2xl font-semibold" data-unit="hours">{initial.hours}</div>
      <div class="text-xs small-muted">Hours</div>
    </div>
    <div>
      <div class="text-2xl font-semibold" data-unit="minutes">{initial.minutes}</div>
      <div class="text-xs small-muted">Minutes</div>
    </div>
    <div>
      <div class="text-2xl font-semibold" data-unit="seconds">{initial.seconds}</div>
      <div class="text-xs small-muted">Seconds</div>
    </div>
  </div>

  <div class="sr-only" aria-live="polite" data-countdown-live>{target ? 'Countdown time remaining' : 'Countdown not set'}</div>
</div>

<script is:inline define:vars={{ uid, target }}>
  (function() {
    const containerId = uid;
    const targetDate = target;
    
    function init() {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const countdownRoot = container.querySelector('[data-countdown]');
      const live = container.querySelector('[data-countdown-live]');
      const units = {
        days: countdownRoot?.querySelector('[data-unit="days"]'),
        hours: countdownRoot?.querySelector('[data-unit="hours"]'),
        minutes: countdownRoot?.querySelector('[data-unit="minutes"]'),
        seconds: countdownRoot?.querySelector('[data-unit="seconds"]')
      };

      if (!targetDate) {
        if (live) live.textContent = 'TBD';
        return;
      }

      const targetDateObj = new Date(targetDate);
      if (isNaN(targetDateObj.getTime())) {
        if (live) live.textContent = 'Date not set';
        return;
      }

      function pad(n) { return String(n).padStart(2, '0'); }

      function update() {
        const now = new Date();
        let diff = Math.max(0, targetDateObj - now);
        const sec = Math.floor(diff / 1000);
        const days = Math.floor(sec / 86400);
        const hours = Math.floor((sec % 86400) / 3600);
        const minutes = Math.floor((sec % 3600) / 60);
        const seconds = sec % 60;

        if (units.days) units.days.textContent = String(days);
        if (units.hours) units.hours.textContent = pad(hours);
        if (units.minutes) units.minutes.textContent = pad(minutes);
        if (units.seconds) units.seconds.textContent = pad(seconds);

        if (live) live.textContent = `${days} days ${pad(hours)}:${pad(minutes)}:${pad(seconds)} remaining`;

        if (diff <= 0) {
          stopTimer();
          if (live) live.textContent = 'Event started';
        }
      }

      let timer = null;
      function startTimer() { 
        if (timer) return; 
        update(); 
        timer = setInterval(update, 1000); 
      }
      function stopTimer() { 
        if (timer !== null) { 
          clearInterval(timer); 
          timer = null; 
        } 
      }

      startTimer();
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) stopTimer(); 
        else startTimer();
      });
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>